name: Build Wolfi APK Packages

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      package_filter:
        description: 'Build specific packages (comma-separated, e.g. "libass,zlib" or leave empty for all)'
        required: false
        default: ''
        type: string
      architectures:
        description: 'Target architectures (comma-separated, e.g. "x86_64" or "x86_64,aarch64")'
        required: false
        default: 'x86_64'
        type: string

permissions:
  contents: read

env:
  MELANGE_VERSION: latest

jobs:
  prepare-build-matrix:
    name: Prepare Build Matrix
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.find-packages.outputs.packages }}
      architectures: ${{ steps.find-packages.outputs.architectures }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find all package configurations
        id: find-packages
        run: |
          # Find all .yaml files in packages/ directory (flat structure like wolfi-os)
          packages=$(find packages -maxdepth 1 -name "*.yaml" -type f | sed 's|packages/||' | sed 's|\.yaml||' | sort -u | jq -R -s -c 'split("\n")[:-1]')

          # If package_filter is set, filter the list
          if [ -n "${{ github.event.inputs.package_filter }}" ]; then
            # Split comma-separated filter into array and match any
            filter_list=$(echo "${{ github.event.inputs.package_filter }}" | jq -R 'split(",")')
            packages=$(echo "$packages" | jq -c --argjson filters "$filter_list" '[.[] | select(. as $pkg | $filters | index($pkg))]')
          fi

          # Process architectures parameter (default: x86_64)
          ARCH_INPUT="${{ github.event.inputs.architectures }}"
          if [ -z "$ARCH_INPUT" ]; then
            ARCH_INPUT="x86_64"
          fi
          architectures=$(echo "$ARCH_INPUT" | jq -R -c 'split(",")')

          echo "packages=$packages" >> $GITHUB_OUTPUT
          echo "architectures=$architectures" >> $GITHUB_OUTPUT
          echo "Found packages:"
          echo "$packages" | jq .
          echo "Target architectures:"
          echo "$architectures" | jq .

  build-packages:
    name: Build ${{ matrix.package }} - ${{ matrix.arch }}
    needs: prepare-build-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.prepare-build-matrix.outputs.packages) }}
        arch: ${{ fromJson(needs.prepare-build-matrix.outputs.architectures) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU for multi-architecture builds
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Create build directories
        run: |
          mkdir -p ./build-output
          mkdir -p ./workspace

      - name: Generate Melange signing key
        run: |
          # Generate signing key using Melange container
          docker run --rm \
            -v $PWD:/work \
            -w /work \
            cgr.dev/chainguard/melange:latest \
            keygen

          # Download official Wolfi signing key for repository verification
          curl -o wolfi-signing.rsa.pub https://packages.wolfi.dev/os/wolfi-signing.rsa.pub

          # Verify keys were created
          ls -lh melange.rsa melange.rsa.pub wolfi-signing.rsa.pub

          # Fix permissions (files created by container are owned by root)
          sudo chown $(id -u):$(id -g) melange.rsa melange.rsa.pub
          chmod 600 melange.rsa
          chmod 644 melange.rsa.pub wolfi-signing.rsa.pub

      - name: Download GRUPO 1 packages from previous build
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Download artifacts from most recent successful build (GRUPO 1)
          # Find the latest successful build run ID
          LATEST_RUN=$(gh run list --workflow=build-packages.yml --status=success --limit=1 --json databaseId --jq '.[0].databaseId' -R ${{ github.repository }})

          if [ -n "$LATEST_RUN" ]; then
            echo "Downloading packages from run $LATEST_RUN"
            mkdir -p ./custom-repo/${{ matrix.arch }}

            # Download all artifacts from that run
            gh run download $LATEST_RUN -D ./artifacts -R ${{ github.repository }} || echo "No artifacts to download"

            # Move APK files to custom-repo
            find ./artifacts -name "*.apk" -exec cp {} ./custom-repo/${{ matrix.arch }}/ \; || echo "No APK files found"

            # Generate APKINDEX for the custom repo
            if [ -d "./custom-repo/${{ matrix.arch }}" ] && [ "$(ls -A ./custom-repo/${{ matrix.arch }}/*.apk 2>/dev/null)" ]; then
              docker run --rm \
                -v $PWD:/work \
                -w /work \
                alpine:latest \
                sh -c "apk add --no-cache apk-tools && cd /work/custom-repo/${{ matrix.arch }} && apk index --allow-untrusted -o APKINDEX.tar.gz *.apk && ls -lh"
            fi

            ls -lh ./custom-repo/${{ matrix.arch }}/
          else
            echo "No previous successful builds found"
            mkdir -p ./custom-repo/${{ matrix.arch }}
          fi

      - name: Build package with Melange
        run: |
          # Use direct path to package YAML file (flat structure like wolfi-os)
          PACKAGE_YAML="packages/${{ matrix.package }}.yaml"

          if [ ! -f "$PACKAGE_YAML" ]; then
            echo "Error: No YAML file found at $PACKAGE_YAML"
            exit 1
          fi

          echo "Building package: ${{ matrix.package }}"
          echo "Using configuration: $PACKAGE_YAML"
          echo "Target architecture: ${{ matrix.arch }}"

          # Build using Melange container
          docker run --rm --privileged \
            -v $PWD:/work \
            -w /work \
            cgr.dev/chainguard/melange:latest \
            build \
            --arch ${{ matrix.arch }} \
            --signing-key melange.rsa \
            --keyring-append melange.rsa.pub \
            --keyring-append wolfi-signing.rsa.pub \
            --repository-append https://packages.wolfi.dev/os \
            --repository-append ./custom-repo \
            --pipeline-dir pipelines \
            --generate-index \
            --out-dir ./build-output \
            "$PACKAGE_YAML"

      - name: List built packages
        run: |
          echo "=== Built APK packages for ${{ matrix.arch }} ==="
          ls -lh ./build-output/${{ matrix.arch }}/

          # Show package info
          for apk in ./build-output/${{ matrix.arch }}/*.apk; do
            if [ -f "$apk" ]; then
              echo "Package: $(basename $apk)"
              echo "Size: $(du -h $apk | cut -f1)"
            fi
          done

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apk-packages-${{ matrix.package }}-${{ matrix.arch }}
          path: ./build-output/${{ matrix.arch }}/*.apk
          retention-days: 30
          if-no-files-found: error

      - name: Upload Melange signing key (for repository signing)
        if: matrix.package == 'stremio' && matrix.arch == 'x86_64'
        uses: actions/upload-artifact@v4
        with:
          name: melange-signing-key
          path: melange.rsa*
          retention-days: 1

  build-summary:
    name: Build Summary
    needs: build-packages
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Display build summary
        run: |
          echo "=== Build Summary ==="
          echo ""
          echo "Total artifacts:"
          find all-artifacts -name "*.apk" | wc -l
          echo ""
          echo "Total size:"
          du -sh all-artifacts
          echo ""
          echo "x86_64 packages:"
          find all-artifacts -path "*x86_64*" -name "*.apk" -exec basename {} \; | sort
