name: Sign and Publish APK Repository

on:
  workflow_run:
    workflows: ["Build Wolfi APK Packages"]
    types:
      - completed
    branches:
      - master
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Build workflow run ID (leave empty for latest successful build)'
        required: false
        type: string
      force_publish:
        description: 'Force publish (ignore build status)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read
  actions: read

jobs:
  sign-and-publish:
    name: Sign and Publish to SourceForge
    runs-on: ubuntu-latest
    # Only run if:
    # 1. Triggered by successful build workflow, OR
    # 2. Manually triggered (workflow_dispatch), OR
    # 3. force_publish is true
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync openssh-client tree

      - name: Get build run ID
        id: get-run-id
        run: |
          if [ -n "${{ github.event.inputs.run_id }}" ]; then
            echo "run_id=${{ github.event.inputs.run_id }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ github.event.workflow_run.id }}" ]; then
            echo "run_id=${{ github.event.workflow_run.id }}" >> $GITHUB_OUTPUT
          else
            # Get latest successful build run
            RUN_ID=$(gh run list -R ${{ github.repository }} --workflow=build-packages.yml --status=success --limit=1 --json databaseId --jq '.[0].databaseId')
            echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          fi
          echo "Using build run ID: $(cat $GITHUB_OUTPUT | grep run_id | cut -d= -f2)"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: build-artifacts
          run-id: ${{ steps.get-run-id.outputs.run_id }}
          github-token: ${{ github.token }}

      - name: Organize repository by architecture
        run: |
          echo "=== Organizing repository by architecture ==="

          # Create repository structure
          mkdir -p repo/x86_64 repo/aarch64 repo/keys

          # Copy APK packages and APKINDEX to appropriate arch directories
          for arch in x86_64 aarch64; do
            echo "Processing $arch artifacts..."

            # Find and copy APK files
            find build-artifacts -path "*${arch}*" -name "*.apk" -exec cp -v {} repo/$arch/ \;

            # Find and copy APKINDEX files (generated by Melange with --generate-index)
            find build-artifacts -path "*${arch}*" -name "APKINDEX.tar.gz" -exec cp -v {} repo/$arch/ \;
          done

          # Copy signing public key from build artifacts (uploaded by build workflow)
          find build-artifacts -name "melange.rsa.pub" -exec cp -v {} repo/keys/vejeta-wolfi.rsa.pub \; || echo "Warning: Public key not found in artifacts"

          echo ""
          echo "=== Repository structure ==="
          tree -h repo/ || find repo/ -type f -exec ls -lh {} \;

      - name: Generate APKINDEX for each architecture
        run: |
          echo "=== Generating APKINDEX ==="

          for arch in x86_64 aarch64; do
            echo "Generating APKINDEX for $arch..."

            cd repo/$arch

            # Use Alpine container to generate APKINDEX (apk index is built-in)
            docker run --rm \
              -v $PWD:/packages \
              -w /packages \
              alpine:latest \
              sh -c "apk index --allow-untrusted -o APKINDEX.tar.gz *.apk && ls -lh APKINDEX.tar.gz"

            cd ../..
          done

          echo "=== APKINDEX files created ==="
          ls -lh repo/*/APKINDEX.tar.gz

      - name: Verify repository structure
        run: |
          echo "=== Final repository structure ==="
          tree -h repo/ || find repo/ -type f -exec ls -lh {} \;

          echo ""
          echo "=== Package count ==="
          echo "x86_64: $(find repo/x86_64 -name "*.apk" | wc -l) packages"
          echo "aarch64: $(find repo/aarch64 -name "*.apk" | wc -l) packages"

          echo ""
          echo "=== Verify APKINDEX exists ==="
          ls -lh repo/x86_64/APKINDEX.tar.gz repo/aarch64/APKINDEX.tar.gz || echo "Warning: APKINDEX files not found"

          echo ""
          echo "=== Total repository size ==="
          du -sh repo/

      - name: Setup SSH for SourceForge
        run: |
          # Create .ssh directory
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Add SourceForge SSH key
          echo "${{ secrets.SOURCEFORGE_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Add SourceForge to known hosts
          ssh-keyscan -H frs.sourceforge.net >> ~/.ssh/known_hosts
          ssh-keyscan -H web.sourceforge.net >> ~/.ssh/known_hosts

          echo "SSH configured for SourceForge"

      - name: Test SourceForge SSH connection
        run: |
          echo "Testing SSH connection to SourceForge..."
          ssh -v jmendezr@frs.sourceforge.net 'echo "SSH connection successful"' || echo "Connection test completed"

      - name: Sync to SourceForge
        run: |
          echo "=== Syncing repository to SourceForge ==="

          chmod +x scripts/sync-sourceforge.sh

          ./scripts/sync-sourceforge.sh \
            repo/ \
            jmendezr@frs.sourceforge.net:/home/frs/project/wolfi/

          echo "Repository published to SourceForge successfully!"

      - name: Create deployment summary
        run: |
          cat > deployment-summary.md << 'EOF'
          # Wolfi APK Repository Deployment Summary

          ## Repository Information

          **SourceForge URL**: https://sourceforge.net/projects/wolfi/files/

          ## Installation Instructions

          ### For Wolfi Linux users:

          ```bash
          # Add repository signing key
          wget -O /etc/apk/keys/vejeta-wolfi.rsa.pub \
            https://sourceforge.net/projects/wolfi/files/keys/vejeta-wolfi.rsa.pub

          # Add repository to /etc/apk/repositories
          echo "https://downloads.sourceforge.net/project/wolfi/repo/$(uname -m)" >> /etc/apk/repositories

          # Update package index
          apk update

          # Install packages
          apk add stremio mpv qt5-qtwebengine
          ```

          ## Package Statistics

          - **x86_64 packages**: $(find repo/x86_64 -name "*.apk" | wc -l)
          - **aarch64 packages**: $(find repo/aarch64 -name "*.apk" | wc -l)
          - **Total size**: $(du -sh repo/ | cut -f1)

          ## Build Information

          - **Workflow**: ${{ github.workflow }}
          - **Run ID**: ${{ github.run_id }}
          - **Commit**: ${{ github.sha }}
          - **Date**: $(date -u +"%Y-%m-%d %H:%M UTC")

          EOF

          cat deployment-summary.md

      - name: Upload deployment summary
        uses: actions/upload-artifact@v4
        with:
          name: deployment-summary
          path: deployment-summary.md
          retention-days: 90

  notify-deployment:
    name: Notify Deployment Status
    needs: sign-and-publish
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.sign-and-publish.result }}" == "success" ]; then
            echo "✅ Repository successfully deployed to SourceForge!"
            echo "Users can now install packages from: https://sourceforge.net/projects/wolfi/files/"
          else
            echo "❌ Deployment failed. Check logs above for details."
            exit 1
          fi
