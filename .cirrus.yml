# ============================================================================
# CIRRUS CI CONFIGURATION - Docker Builder with ARM64
# ============================================================================
#
# Uses Cirrus CI's Docker Builder on Google Compute Engine ARM64 VMs
# This provides PRIVILEGED container support, allowing melange to work properly
#
# Key differences from previous approach:
# - Uses docker_builder instead of arm_container
# - Runs melange in privileged Docker container (no QEMU wrapper needed)
# - Can use bubblewrap runner (native, fast)
# - No initramfs combination hacks required
#
# Resources: 4 CPUs, 16GB RAM (Google Compute Engine ARM64 VM)
# ============================================================================

docker_builder:
  name: Build stremio-server (ARM64 with privileged Docker)
  only_if: $CIRRUS_BRANCH == 'master' || $CIRRUS_BRANCH == 'main'

  env:
    CIRRUS_ARCH: arm64
    ARCH: aarch64
    MELANGE_VERSION: latest
    APK_SIGNING_KEY: ENCRYPTED[!1ef534804032cc4990b3feb5c4dbe292a23b5003dbfacd059aa9ca3ea63a950eb975838ae6e1305303df4217c8caf97c!]
    SOURCEFORGE_SSH_KEY: ENCRYPTED[!44121f8bf7e805b7a6909b257b62d70c762bb2c9a526f2a6cd641db8d2bb5e1e3ccbeb3848ef8dca77964a16a25e678c!]

  # Generate signing keys
  setup_keys_script:
    - |
      # Use encrypted production key if building on master/main
      if [ "$CIRRUS_BRANCH" = "master" ] || [ "$CIRRUS_BRANCH" = "main" ]; then
        echo "Using encrypted APK signing key for production builds"

        # Cirrus CI auto-decrypts ENCRYPTED[] vars - write to temp file
        echo "$APK_SIGNING_KEY" > melange-pkcs8.rsa
        chmod 600 melange-pkcs8.rsa

        # Convert PKCS#8 to PKCS#1 format (required by melange)
        openssl rsa -in melange-pkcs8.rsa -out melange.rsa -traditional
        chmod 600 melange.rsa
        rm melange-pkcs8.rsa

        # Generate public key from private key
        openssl rsa -in melange.rsa -pubout > melange.rsa.pub
        chmod 644 melange.rsa.pub
      else
        echo "Generating ephemeral signing keys for branch builds"
        docker run --rm -v "$PWD:/work" cgr.dev/chainguard/melange:latest keygen /work/melange.rsa
      fi

      # Download official Wolfi signing key for dependency resolution
      wget -q https://packages.wolfi.dev/os/wolfi-signing.rsa.pub -O wolfi-signing.rsa.pub

      echo "âœ“ Signing keys ready (PKCS#1 format)"
      ls -lh melange.rsa* wolfi-signing.rsa.pub

  # Build stremio-server with privileged melange container
  build_script:
    - |
      mkdir -p build-output/aarch64

      echo "Building stremio-server for ARM64 using privileged Docker container..."
      docker run --rm --privileged \
        -v "$PWD:/work" \
        -w /work \
        cgr.dev/chainguard/melange:latest \
        build \
        --arch aarch64 \
        --signing-key melange.rsa \
        --keyring-append melange.rsa.pub \
        --keyring-append wolfi-signing.rsa.pub \
        --repository-append https://packages.wolfi.dev/os \
        --pipeline-dir pipelines \
        --out-dir build-output/aarch64 \
        packages/stremio-server.yaml

      echo ""
      echo "=== Build output ==="
      ls -lh build-output/aarch64/

  # Download existing packages from SourceForge to include in APKINDEX
  download_existing_packages_script:
    - |
      echo "=== Downloading existing aarch64 packages from SourceForge ==="

      mkdir -p existing-packages/aarch64

      # Check if SOURCEFORGE_SSH_KEY is available
      if [ -n "$SOURCEFORGE_SSH_KEY" ]; then
        echo "Downloading existing packages via SFTP..."

        # Setup SSH
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        echo "$SOURCEFORGE_SSH_KEY" > ~/.ssh/sourceforge_wolfi_rsa
        chmod 600 ~/.ssh/sourceforge_wolfi_rsa
        ssh-keyscan -H frs.sourceforge.net >> ~/.ssh/known_hosts

        # Install lftp
        apt-get update && apt-get install -y lftp

        # Download using SFTP (same as GitHub Actions)
        lftp -c "
          set ssl:verify-certificate no
          set net:timeout 60
          set net:max-retries 3
          open sftp://jmendezr@frs.sourceforge.net
          mirror --verbose --exclude-glob 'APKINDEX*' \
            /home/frs/project/wolfi/aarch64/ existing-packages/aarch64/
        " || echo "No existing packages for aarch64 (first publish?)"

        # Cleanup SSH key
        rm ~/.ssh/sourceforge_wolfi_rsa

        PKG_COUNT=$(find existing-packages/aarch64 -name "*.apk" 2>/dev/null | wc -l)
        echo "Downloaded $PKG_COUNT existing packages from SourceForge"
      else
        echo "WARNING: SOURCEFORGE_SSH_KEY not set - skipping download"
        echo "APKINDEX will only include newly built packages"
        echo "To fix: Add SOURCEFORGE_SSH_KEY as encrypted variable in Cirrus CI"
      fi

  # Merge new and existing packages, then generate APKINDEX
  generate_apkindex_script:
    - |
      echo "=== Merging packages and generating APKINDEX ==="

      mkdir -p final-output/aarch64

      # Copy existing packages first (if any exist)
      if ls existing-packages/aarch64/*.apk 1>/dev/null 2>&1; then
        cp -v existing-packages/aarch64/*.apk final-output/aarch64/
        echo "Copied existing packages"
      else
        echo "No existing packages to copy"
      fi

      # Copy newly built packages (overwrites if same name/version)
      if ls build-output/aarch64/*.apk 1>/dev/null 2>&1; then
        cp -v build-output/aarch64/*.apk final-output/aarch64/
        echo "Copied newly built packages"
      else
        echo "No newly built packages to copy"
      fi

      # Count packages
      TOTAL_PKGS=$(find final-output/aarch64 -name "*.apk" 2>/dev/null | wc -l)
      echo "Total packages to include in APKINDEX: $TOTAL_PKGS"

      # List what we have
      ls -lh final-output/aarch64/ || true

      if [ "$TOTAL_PKGS" -gt 0 ]; then
        # Copy signing key into directory for Docker access
        cp melange.rsa final-output/aarch64/

        cd final-output/aarch64

        # Generate and sign APKINDEX using Alpine container
        docker run --rm \
          -v $PWD:/work \
          -w /work \
          alpine:latest \
          sh -c "apk add --no-cache apk-tools abuild && \
            apk index --allow-untrusted -o APKINDEX.tar.gz *.apk && \
            abuild-sign -k /work/melange.rsa APKINDEX.tar.gz && \
            ls -lh APKINDEX.tar.gz"

        # Remove signing key from output directory (security)
        rm melange.rsa

        cd ../..

        echo "APKINDEX generated and signed successfully"
        ls -lh final-output/aarch64/APKINDEX.tar.gz
      else
        echo "ERROR: No packages found to index!"
        exit 1
      fi

  # Upload build artifacts
  apk_packages_artifacts:
    path: "final-output/aarch64/*.apk"

  apkindex_artifacts:
    path: "final-output/aarch64/APKINDEX.tar.gz"
