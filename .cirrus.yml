# Cirrus CI - Build ARM64 packages natively
# Free for open source projects, no 6-hour limit
# Uses AWS Graviton2 (ARM64 native)

task:
  name: Build Wolfi Packages (aarch64)
  only_if: $CIRRUS_BRANCH == 'master' || $CIRRUS_BRANCH == 'main'

  # ARM64 nativo en AWS Graviton2 - 8 CPUs, 24GB RAM
  arm_container:
    image: alpine:latest
    cpu: 8
    memory: 24G

  env:
    ARCH: aarch64
    MELANGE_VERSION: latest
    APK_SIGNING_KEY: ENCRYPTED[!1ef534804032cc4990b3feb5c4dbe292a23b5003dbfacd059aa9ca3ea63a950eb975838ae6e1305303df4217c8caf97c!]
                         

  # Instalar dependencias del sistema
  install_deps_script:
    - apk add --no-cache curl git bash bubblewrap wget tar gzip jq openssl

  # Instalar Melange ARM64
  install_melange_script:
    - |
      if [ "$MELANGE_VERSION" = "latest" ]; then
        # Get latest release tag from GitHub API
        ACTUAL_VERSION=$(curl -s https://api.github.com/repos/chainguard-dev/melange/releases/latest | jq -r '.tag_name')
        echo "Using Melange latest version: $ACTUAL_VERSION"
      else
        ACTUAL_VERSION="$MELANGE_VERSION"
        echo "Using Melange version: $ACTUAL_VERSION"
      fi

      # Download and install Melange
      wget -q https://github.com/chainguard-dev/melange/releases/download/${ACTUAL_VERSION}/melange_${ACTUAL_VERSION#v}_linux_arm64.tar.gz
      tar -xzf melange_${ACTUAL_VERSION#v}_linux_arm64.tar.gz
      find . -name "melange" -type f -exec mv {} /usr/local/bin/ \;
      chmod +x /usr/local/bin/melange
      melange version
      rm -f melange_${ACTUAL_VERSION#v}_linux_arm64.tar.gz

  # Setup signing keys (permanent key from Cirrus CI encrypted variable + official Wolfi key)
  setup_keys_script:
    - |
      # Check if APK_SIGNING_KEY is set (encrypted variable from Cirrus CI)
      if [ -z "$APK_SIGNING_KEY" ]; then
        echo "WARNING: APK_SIGNING_KEY not set - falling back to temporary key"
        echo "For production builds, add APK_SIGNING_KEY as encrypted variable in Cirrus CI settings"
        melange keygen
      else
        echo "Using permanent signing key from Cirrus CI encrypted variable"

        # Save PKCS#8 key from environment variable (using printf to preserve formatting)
        printf '%s\n' "$APK_SIGNING_KEY" > melange-pkcs8.rsa
        chmod 600 melange-pkcs8.rsa

        # Debug: Check if key file was created correctly
        echo "Key file size: $(wc -c < melange-pkcs8.rsa) bytes"
        echo "First line: $(head -1 melange-pkcs8.rsa)"

        # Convert PKCS#8 to PKCS#1 format (required by Melange)
        openssl rsa -in melange-pkcs8.rsa -out melange.rsa -traditional
        chmod 600 melange.rsa
        rm melange-pkcs8.rsa

        # Extract public key from private key
        openssl rsa -in melange.rsa -pubout > melange.rsa.pub
        chmod 644 melange.rsa.pub

        echo "Signing key converted and ready for use"
      fi
    - wget -q -O wolfi-signing.rsa.pub https://packages.wolfi.dev/os/wolfi-signing.rsa.pub
    - ls -lh melange.rsa melange.rsa.pub wolfi-signing.rsa.pub

  # Ejecutar script de build para todos los packages aarch64
  build_script:
    - chmod +x scripts/build-cirrus-aarch64.sh
    - ./scripts/build-cirrus-aarch64.sh

  # Siempre subir artifacts (incluso si algunos packages fallan)
  always:
    # Upload individual APK packages
    apk_packages_artifacts:
      path: "build-output/aarch64/*.apk"
      type: application/octet-stream

    # Upload APKINDEX
    apkindex_artifacts:
      path: "build-output/aarch64/APKINDEX.tar.gz"
      type: application/gzip
