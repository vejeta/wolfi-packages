# Cirrus CI - Showcase: Build stremio-server on ARM64
#
# This is a simplified example showing Cirrus CI ARM64 native builds.
# stremio-server is a pure Node.js application (no compilation needed)
# so it builds quickly without QEMU complexity.
#
# For production builds of all packages, see GitHub Actions which uses
# native ARM64 runners (ubuntu-24.04-arm) with bubblewrap for fast builds.

task:
  name: Build stremio-server (ARM64 showcase)
  only_if: $CIRRUS_BRANCH == 'master' || $CIRRUS_BRANCH == 'main'

  # ARM64 native on AWS Graviton2 - lightweight resources for simple builds
  arm_container:
    image: alpine:latest
    cpu: 2
    memory: 4G

  env:
    ARCH: aarch64
    MELANGE_VERSION: latest
    APK_SIGNING_KEY: ENCRYPTED[!1ef534804032cc4990b3feb5c4dbe292a23b5003dbfacd059aa9ca3ea63a950eb975838ae6e1305303df4217c8caf97c!]

  # Install dependencies (including QEMU for emulation)
  install_deps_script:
    - apk add --no-cache curl git bash qemu-system-aarch64 linux-virt wget tar gzip jq openssl cpio file
    - |
      # Check if virtio modules are available in the installed system
      echo "Checking for virtio modules in installed system..."
      if [ -d "/lib/modules" ]; then
        echo "  System modules directory exists:"
        ls -la /lib/modules/ 2>/dev/null | head -5
        KERNEL_VER=$(ls /lib/modules/ 2>/dev/null | head -1)
        if [ -n "$KERNEL_VER" ]; then
          echo "  Found kernel version: $KERNEL_VER"
          echo "  Searching for virtio modules:"
          find /lib/modules/$KERNEL_VER -name "*virtio*" -type f 2>/dev/null | head -10 || echo "    No virtio modules found in system"
        fi
      fi

  # Install Melange
  install_melange_script:
    - |
      ACTUAL_VERSION=$(curl -s https://api.github.com/repos/chainguard-dev/melange/releases/latest | jq -r '.tag_name')
      echo "Installing Melange $ACTUAL_VERSION for ARM64"
      wget -q https://github.com/chainguard-dev/melange/releases/download/${ACTUAL_VERSION}/melange_${ACTUAL_VERSION#v}_linux_arm64.tar.gz
      tar -xzf melange_${ACTUAL_VERSION#v}_linux_arm64.tar.gz
      find . -name "melange" -type f -exec mv {} /usr/local/bin/ \;
      chmod +x /usr/local/bin/melange
      melange version
      rm -f melange_${ACTUAL_VERSION#v}_linux_arm64.tar.gz

  # Force QEMU to use TCG instead of KVM
  setup_qemu_tcg_script:
    - |
      echo "=========================================="
      echo "FORCE QEMU TO USE TCG"
      echo "=========================================="

      # Rename the real QEMU binary
      mv /usr/bin/qemu-system-aarch64 /usr/bin/qemu-system-aarch64.real

      # Create wrapper that forces TCG
      cat > /usr/bin/qemu-system-aarch64 << 'EOFQEMU'
      #!/bin/sh
      # Force TCG acceleration (KVM not available in containers)

      # Build properly quoted arguments, replacing kvm with tcg
      new_args=""
      for arg in "$@"; do
        if [ "$arg" = "kvm" ]; then
          new_args="$new_args tcg"
        else
          # Properly escape single quotes in arguments
          escaped=$(printf '%s' "$arg" | sed "s/'/'\\\\''/g")
          new_args="$new_args '$escaped'"
        fi
      done

      # Execute real QEMU with eval to handle quoting
      eval exec /usr/bin/qemu-system-aarch64.real $new_args
      EOFQEMU

      chmod +x /usr/bin/qemu-system-aarch64

      # Verify it works
      echo "Testing QEMU wrapper..."
      /usr/bin/qemu-system-aarch64 --version
      echo "✓ QEMU wrapper installed"

  # Setup kernel and initramfs for melange QEMU runner
  setup_kernel_script:
    - |
      echo "=========================================="
      echo "SETUP KERNEL SCRIPT"
      echo "=========================================="

      # QEMU runner requires kernel and initramfs from linux-virt package
      KERNEL_PATH="/boot/vmlinuz-virt"
      INITRAMFS_PATH="/boot/initramfs-virt"

      echo "Verifying kernel and initramfs..."
      if [ ! -f "$KERNEL_PATH" ]; then
        echo "ERROR: Kernel not found at $KERNEL_PATH"
        ls -lh /boot/
        exit 1
      fi

      if [ ! -f "$INITRAMFS_PATH" ]; then
        echo "ERROR: Initramfs not found at $INITRAMFS_PATH"
        ls -lh /boot/
        exit 1
      fi

      KERNEL_SIZE=$(stat -c%s $KERNEL_PATH)
      INITRAMFS_SIZE=$(stat -c%s $INITRAMFS_PATH)
      echo "✓ Kernel: $KERNEL_PATH ($KERNEL_SIZE bytes)"
      echo "✓ Initramfs: $INITRAMFS_PATH ($INITRAMFS_SIZE bytes)"
      echo ""

      # Export paths for melange
      echo "export QEMU_KERNEL_IMAGE=$KERNEL_PATH" >> $CIRRUS_ENV
      echo "export QEMU_KERNEL_INITRD=$INITRAMFS_PATH" >> $CIRRUS_ENV
      echo "✓ QEMU_KERNEL_IMAGE and QEMU_KERNEL_INITRD exported for melange"

  # Setup signing keys
  setup_keys_script:
    - |
      printf '%s\n' "$APK_SIGNING_KEY" > melange-pkcs8.rsa
      openssl rsa -in melange-pkcs8.rsa -out melange.rsa -traditional
      openssl rsa -in melange.rsa -pubout > melange.rsa.pub
      rm melange-pkcs8.rsa
      wget -q -O wolfi-signing.rsa.pub https://packages.wolfi.dev/os/wolfi-signing.rsa.pub

  # Build stremio-server (Node.js package, simple showcase build)
  build_script:
    - mkdir -p build-output/aarch64 build-output/logs
    - |
      # Source environment variables from CIRRUS_ENV
      if [ -f "$CIRRUS_ENV" ]; then
        echo "Loading environment variables from $CIRRUS_ENV:"
        cat "$CIRRUS_ENV"
        set -a
        source "$CIRRUS_ENV"
        set +a
      fi

      # Export kernel and initramfs paths for melange
      export QEMU_KERNEL_IMAGE=${QEMU_KERNEL_IMAGE:-/boot/vmlinuz-virt}
      export QEMU_KERNEL_INITRD=${QEMU_KERNEL_INITRD:-/boot/initramfs-virt}

      echo "=========================================="
      echo "BUILD ENVIRONMENT"
      echo "=========================================="
      echo "QEMU_KERNEL_IMAGE: $QEMU_KERNEL_IMAGE"
      echo "QEMU_KERNEL_INITRD: $QEMU_KERNEL_INITRD"
      echo "Architecture: aarch64"
      echo "Package: stremio-server"
      echo ""
      echo "Using Alpine's initramfs (has virtio modules and mount command)"
      echo ""

      # Build stremio-server
      melange build \
        --runner qemu \
        --arch aarch64 \
        --signing-key melange.rsa \
        --keyring-append melange.rsa.pub \
        --keyring-append wolfi-signing.rsa.pub \
        --repository-append https://packages.wolfi.dev/os \
        --pipeline-dir pipelines \
        --out-dir build-output/aarch64 \
        packages/stremio-server.yaml 2>&1 | tee /tmp/melange-build.log

    - echo "=== Build output ==="
    - ls -lh build-output/aarch64/ || true

  # Upload artifacts
  always:
    apk_packages_artifacts:
      path: "build-output/aarch64/*.apk"
